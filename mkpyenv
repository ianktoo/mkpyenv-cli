#!/bin/bash
# Terminal Guardian: Elite DevOps Specialist Script - FIXED VERSION v2.0.0

# --- SECURITY & ERROR HANDLING ---
# Exit immediately if a command exits with a non-zero status.
set -e
# Exit on any failure in a pipeline.
set -o pipefail 

# Define the version of this fixed script. This allows it to pass the check.
CURRENT_SCRIPT_VERSION="2.0.0" 

# --- CONFIGURATION ---
TEMPLATE_ROOT="$HOME/templates"
# Define where your templates live
TEMPLATE_SRC="$TEMPLATE_ROOT/python-standard"
# ---------------------

# 1. Input Validation and Help Flag Check
# Check specifically for the --help flag
if [[ "$1" == "--help" || "$1" == "-h" ]]; then
    echo "üìò Usage: mkpyenv <project_name>"
    echo "  Initializes a new Python project by copying the standard template."
    echo "  Version: v$CURRENT_SCRIPT_VERSION"
    echo ""
    echo "Arguments:"
    echo "  <project_name>    The name of the new project directory."
    exit 0
fi

# Check if an argument was provided at all
if [ -z "$1" ]; then
    echo "‚ùå Error: No directory name provided."
    echo "Usage: mkpyenv <project_name>"
    echo "Run 'mkpyenv --help' for more information."
    exit 1
fi

PROJECT_NAME="$1"
PROJECT_DIR="$(pwd)/$PROJECT_NAME"

# 2. Check if Template Exists
if [ ! -d "$TEMPLATE_SRC" ]; then
    echo "‚ùå Error: Template directory not found at $TEMPLATE_SRC"
    exit 1
fi

# 3. Create Project Directory
if [ -d "$PROJECT_DIR" ]; then
    echo "‚ö†Ô∏è  Directory **$PROJECT_NAME** already exists. Aborting to prevent overwrite."
    exit 1
fi

mkdir -p "$PROJECT_DIR"
echo "üìÇ Created directory: **$PROJECT_NAME**"

# 4. Clone Template Files
cp -r "$TEMPLATE_SRC/." "$PROJECT_DIR/"
echo "üìÑ Template files copied."

# 5. Dynamic Placeholder Replacement (Hydration)
# Use sed -i.bak for in-place edit with a backup, and clean up the backup files.
sed -i.bak "s/{{PROJECT_NAME}}/$PROJECT_NAME/g" "$PROJECT_DIR/README.md"
sed -i.bak "s/{{PROJECT_NAME}}/$PROJECT_NAME/g" "$PROJECT_DIR/main.py"
find "$PROJECT_DIR" -type f -name "*.bak" -delete

# 6. Create Virtual Environment
echo "üêç Creating Python virtual environment..."
cd "$PROJECT_DIR" || exit 1
python3 -m venv .venv

# 7. Completion
echo "---------------------------------------"
echo "‚úÖ Project '$PROJECT_NAME' initialized!"
echo "üìÇ Location: $PROJECT_DIR"
echo "üëâ To start: source .venv/bin/activate"
echo "---------------------------------------"
